<!DOCTYPE html>
<html lang="zh" data-theme="happy">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>å°åŒ—çš„æƒ…ç»ªæ—¥è®° Â· v4.1</title>
<style>
  :root{
    --text:#111827; --muted:#6b7280;
    --card: rgba(255,255,255,.86);
    --chip: rgba(255,255,255,.96);
    --happy:#ff9cc6; --sad:#9ab6ff; --blank:#69d3b0; --angry:#ffb277;
  }
  html[data-theme="happy"] { --accent:var(--happy); --g1:#fff1f6; --g2:#ffe4e6; --g3:#ffd8e4; }
  html[data-theme="sad"]   { --accent:var(--sad);   --g1:#eef4ff; --g2:#e0eaff; --g3:#d6e6ff; }
  html[data-theme="blank"] { --accent:var(--blank); --g1:#ecfdf5; --g2:#defcf3; --g3:#d0f7e8; }
  html[data-theme="angry"] { --accent:var(--angry); --g1:#fff4e6; --g2:#ffe8cc; --g3:#ffdcb5; }

  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh; color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans SC","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
    background:
      radial-gradient(1200px 800px at 10% 10%, var(--g1), transparent 60%),
      radial-gradient(1000px 700px at 90% 20%, var(--g2), transparent 60%),
      radial-gradient(900px 600px at 30% 90%, var(--g3), transparent 60%),
      linear-gradient(180deg, var(--g1), var(--g2));
  }

  .wrap{ width:clamp(320px, 92vw, 1080px); margin:0 auto; padding:26px 12px 70px; text-align:center; }

  h1{ margin:0 0 6px; font-weight:900; font-size:clamp(30px,4.5vw,44px); letter-spacing:.2px;}
  .sub{ margin:0 0 14px; color:var(--muted); font-size:14px; }

  .bar{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin:12px 0 6px; }
  .btn{
    appearance:none;border:1.5px solid #e5e7eb;cursor:pointer; padding:8px 14px;border-radius:999px;
    font-size:14px;font-weight:700; background:#fff; color:#111827;
    transition: transform .08s ease, filter .2s ease, border-color .2s ease, box-shadow .2s ease, background .2s ease;
  }
  .btn:hover{ transform: translateY(-1px); filter:brightness(1.02); }
  .btn:active{ transform: translateY(1px) scale(.98); }
  .btn.is-active{ border-color: var(--accent); background: #fff6; box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 25%, transparent); }

  .card{
    margin:12px auto; padding:14px; border-radius:16px;
    width:min(1080px, 98%);
    background: var(--card);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    box-shadow: 0 8px 32px rgba(0,0,0,.12);
    text-align:left;
  }

  /* top card */
  .row-top{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; align-items:start; }
  @media (max-width:900px){ .row-top{ grid-template-columns: 1fr; } }
  .imgbox{ display:flex; align-items:center; justify-content:center; }
  #xiaobei-img{ max-width:min(460px,100%); border-radius:14px; }

  .col-right{ display:grid; grid-template-rows: auto auto; gap:10px; }

  .text-block{
    padding:12px 14px; border-radius:14px; background:#fff; box-shadow: 0 1px 0 rgba(0,0,0,.03) inset;
  }
  .emotion-title{ margin:0 0 8px; font-size:clamp(26px,3.2vw,32px); font-weight:900; }
  .emotion-title .label{ color:#111827; }
  .emotion-title .value{ color:var(--accent); font-weight:900; font-size:1.1em; }
  .emotion-sub{ margin:0 0 8px; font-size:clamp(16px,2.1vw,18px); color:#475569; }

  /* diary bubble with accent border and footer tools */
  .bubble{
    position:relative; margin:10px 0 0; border-radius:16px; background:#fff;
    border:2px solid color-mix(in srgb, var(--accent) 35%, #e5e7eb);
    box-shadow: 0 2px 10px rgba(0,0,0,.05);
    overflow:hidden;
  }
  .bubble::before{ content:""; position:absolute; left:0; top:0; bottom:44px; width:3px; background:var(--accent); opacity:.6; }
  .bubble .content{ padding:12px 14px; font-size:clamp(16px,2.1vw,18px); line-height:1.8; color:#111827; }
  .bubble .fav-badge{
    position:absolute; right:10px; top:10px; font-size:14px; display:none;
  }
  .bubble.faved .fav-badge{ display:inline; }
  .bubble .footer{
    display:flex; align-items:center; gap:8px; padding:8px 10px; border-top:1px solid #eef2f7; background: #fafafa;
  }
  .pill{
    padding:6px 10px; border-radius:999px; border:1px solid #e5e7eb; background:#fff;
    font-size:13px; display:inline-flex; align-items:center; gap:6px; cursor:pointer;
  }
  .pill:active{ transform:translateY(1px); }
  .pill .ico{ font-size:16px; }

  /* TTS segmented control redesign */
  .tts-seg{ display:inline-flex; background:#fff; border:1px solid #e5e7eb; border-radius:999px; overflow:hidden; }
  .tts-seg button{
    padding:6px 12px; font-size:12px; border:none; background:#fff; cursor:pointer; display:flex; align-items:center; gap:6px;
  }
  .tts-seg button .dot{ width:8px; height:8px; border-radius:50%; background:#e5e7eb; }
  .tts-seg button.is-on{ background: color-mix(in srgb, var(--accent) 12%, #fff); font-weight:700; }
  .tts-seg button.is-on .dot{ background: var(--accent); }
  .switch{ display:inline-flex; align-items:center; gap:6px; }
  .switch input{ width:36px; height:20px; appearance:none; background:#e5e7eb; border-radius:999px; position:relative; outline:none; cursor:pointer;}
  .switch input:checked{ background:color-mix(in srgb, var(--accent) 45%, #e5e7eb); }
  .switch input::after{ content:""; position:absolute; width:16px; height:16px; top:2px; left:2px; background:#fff; border-radius:50%; transition: left .15s; }
  .switch input:checked::after{ left:18px; }

  .tip{ margin-top:8px; padding:8px 10px; border-radius:10px; background:rgba(0,0,0,.04); color:#374151; font-size:13px; }
  .info-strip{ margin-top:6px; font-size:12px; color:#6b7280; }

  /* mid grid */
  .mid-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
  @media (max-width:900px){ .mid-grid{ grid-template-columns: 1fr; } }

  .section-title{ margin:6px 0 8px; font-size:15px; color:#374151; font-weight:800; display:flex; align-items:center; justify-content:space-between; }
  .section-title .small{ font-size:12px; color:#6b7280; }

  .stats{ display:flex; flex-direction:column; gap:10px; }
  .stats .filters{ display:flex; gap:6px; flex-wrap:wrap; }

  .barrow{ display:flex; align-items:center; gap:10px; }
  .barrow .label{ width:44px; text-align:right; font-size:12px; color:#374151; }
  .barwrap{ flex:1; height:16px; background:#fff; border-radius:999px; overflow:hidden; }
  .barval{ height:100%; width:0%; transition: width .4s ease; background:linear-gradient(90deg, color-mix(in srgb, var(--accent) 55%, #fff), color-mix(in srgb, var(--accent) 5%, #fff) 95%); }

  .fav-list{ display:flex; flex-direction:column; gap:8px; max-height:260px; overflow:auto; padding-right:4px; }
  .fav-item{ display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:12px; background: var(--chip); font-size:14px; }
  .fav-item small{ color:#6b7280; }
  .fav-left{ flex:1 1 auto; min-width:0; }
  .fav-text{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  .fav-item .remove{ flex:0 0 auto; white-space:nowrap; line-height:1; padding:4px 8px; font-size:12px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
  .fav-item .remove:active{ transform:translateY(1px); }

  .chips{ display:grid; gap:8px; grid-template-columns: repeat(5, 1fr); }
  @media (max-width:900px){ .chips{ grid-template-columns: repeat(3, 1fr); } }
  @media (max-width:560px){ .chips{ grid-template-columns: repeat(2, 1fr); } }
  .chip{ padding:8px 10px; border-radius:12px; background:var(--chip); font-size:12px; color:#111827; user-select:none; text-align:center; border:1px solid #e5e7eb; }
  .chip.happy{ background: color-mix(in srgb, var(--happy) 15%, #fff); }
  .chip.sad{ background: color-mix(in srgb, var(--sad) 15%, #fff); }
  .chip.blank{ background: color-mix(in srgb, var(--blank) 15%, #fff); }
  .chip.angry{ background: color-mix(in srgb, var(--angry) 15%, #fff); }

  footer{ margin-top:14px; color:#6b7280; font-size:12px; text-align:center; }

  .toast{
    position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%);
    background: #111827; color:#fff; padding:10px 14px; border-radius:999px; font-size:13px;
    opacity:0; pointer-events:none; transition: opacity .2s, transform .2s;
  }
  .toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px); }
</style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ¯ å°åŒ—çš„æƒ…ç»ªæ—¥è®°</h1>
    <p class="sub">ç‚¹å‡»å¿ƒæƒ…åˆ‡æ¢ï¼›éšæœºå°æ—¥è®°ä¸æ”¶è—ï¼›ç»Ÿè®¡é¢æ¿ä¸å†å²è®°å½•ï¼Œæœ¬åœ°ä¿å­˜ã€‚</p>

    <div class="bar" role="group" aria-label="æƒ…ç»ªé€‰æ‹©">
      <button class="btn" data-key="happy" aria-pressed="true">å¼€å¿ƒ</button>
      <button class="btn" data-key="sad" aria-pressed="false">éš¾è¿‡</button>
      <button class="btn" data-key="blank" aria-pressed="false">æ”¾ç©º</button>
      <button class="btn" data-key="angry" aria-pressed="false">ç”Ÿæ°”</button>
    </div>

    <div class="card">
      <div class="row-top">
        <div class="imgbox">
          <img id="xiaobei-img" src="happy.png" alt="å°åŒ—è¡¨æƒ…"/>
        </div>
        <div class="col-right">
          <div class="text-block">
            <div class="emotion-title"><span class="label">å°åŒ—ç°åœ¨çš„æƒ…ç»ªæ˜¯ï¼š</span><span id="emotion-text" class="value">å¼€å¿ƒ</span></div>
            <div class="emotion-sub" id="emotion-sub">â€œä»Šå¤©ä¹Ÿè¦è¢«å¥½å¥½æŠ±æŠ±ï½â€</div>

            <div class="bubble" id="bubble">
              <span class="fav-badge" id="bubble-fav">â¤ï¸</span>
              <div class="content" id="emotion-diary"></div>
              <div class="footer">
                <button class="pill" id="btn-next"><span class="ico">ğŸ”€</span><span>æ¢ä¸€æ¡</span></button>
                <button class="pill" id="btn-fav"><span class="ico">â¤ï¸</span><span>æ”¶è—</span></button>
                <span class="pill" style="gap:10px; background:#fff;">
                  <span class="ico">ğŸ”Š</span>
                  <span class="tts-seg" id="tts-seg">
                    <button data-mode="explain" class="is-on"><span class="dot"></span>è§£é‡Š</button>
                    <button data-mode="diary"><span class="dot"></span>æ—¥è®°</button>
                  </span>
                  <label class="switch"><input type="checkbox" id="tts-toggle" aria-label="å¼€å¯è¯­éŸ³æ’­æŠ¥"></label>
                </span>
              </div>
            </div>

            <div class="tip" id="care-tip"></div>
            <div class="info-strip" id="info-strip">ğŸ“… ä»Šå¤© Â· <span id="info-time">--:--</span> ï½œ æœ¬æƒ…ç»ªç¬¬ <span id="info-index">1</span> æ¡æ—¥è®°</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="mid-grid">
        <div>
          <div class="section-title">ğŸ“Š æƒ…ç»ªç»Ÿè®¡ <span class="small">ï¼ˆæ¥è‡ªæœ€è¿‘è®°å½•ï¼‰</span></div>
          <div class="stats">
            <div class="filters">
              <button class="btn" style="padding:6px 10px;font-size:12px" data-range="7">æœ€è¿‘7å¤©</button>
              <button class="btn" style="padding:6px 10px;font-size:12px" data-range="30">æœ€è¿‘30å¤©</button>
              <button class="btn" style="padding:6px 10px;font-size:12px" data-range="all">å…¨éƒ¨</button>
            </div>
            <div id="stat-happy" class="barrow"><div class="label">å¼€å¿ƒ</div><div class="barwrap"><div class="barval"></div></div><span class="count"></span></div>
            <div id="stat-sad" class="barrow"><div class="label">éš¾è¿‡</div><div class="barwrap"><div class="barval"></div></div><span class="count"></span></div>
            <div id="stat-blank" class="barrow"><div class="label">æ”¾ç©º</div><div class="barwrap"><div class="barval"></div></div><span class="count"></span></div>
            <div id="stat-angry" class="barrow"><div class="label">ç”Ÿæ°”</div><div class="barwrap"><div class="barval"></div></div><span class="count"></span></div>
          </div>
        </div>
        <div>
          <div class="section-title">ğŸ’– æ”¶è—å¤¹ <span class="small">ï¼ˆç‚¹å‡»å³ä¾§åƒåœ¾æ¡¶ç§»é™¤ï¼‰</span></div>
          <div id="fav-list" class="fav-list"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">ğŸ•’ æœ€è¿‘ 10 æ¬¡å¿ƒæƒ…
        <button id="clear-history" class="btn" style="padding:6px 10px;font-size:12px">æ¸…ç©º</button>
      </div>
      <div id="chips" class="chips" aria-live="polite"></div>
    </div>

    <footer>æ•°æ®ä¿å­˜åœ¨æœ¬åœ°ï¼šåˆ·æ–°ä¹Ÿä¼šè®°ä½å°åŒ—çš„æœ€æ–°å¿ƒæƒ…ã€æ”¶è—ä¸å†å²ã€‚</footer>
  </div>
  <div id="toast" class="toast">å·²æ”¶è—</div>

<script>
(function(){
  const EMOTIONS = {
    happy : { label:"å¼€å¿ƒ",  img:"happy.png",  line:"â€œä»Šå¤©ä¹Ÿè¦è¢«å¥½å¥½æŠ±æŠ±ï½â€", color:"var(--happy)" },
    sad   : { label:"éš¾è¿‡",  img:"sad.png",    line:"â€œå‘œå‘œï¼Œä»Šå¤©æœ‰ç‚¹å°éš¾è¿‡â€¦â€", color:"var(--sad)" },
    blank : { label:"æ”¾ç©º",  img:"blank.png",  line:"â€œå…ˆå•¥ä¹Ÿä¸æƒ³ï¼Œå‘ä¼šå„¿å‘†ã€‚â€", color:"var(--blank)" },
    angry : { label:"ç”Ÿæ°”",  img:"angry.png",  line:"â€œå…ˆå‘¼ä¸€å£æ°”ï¼Œå†æŠ±æŠ±ä½ ã€‚â€", color:"var(--angry)" },
  };
  const ENTRIES = {
    "happy": [
      "ä»Šå¤©é˜³å…‰å¥½æš–ï¼Œæˆ‘åœ¨çª—è¾¹æ™’äº†ä¸€ä¸‹åˆï¼Œè§‰å¾—è‡ªå·±æ˜¯ä¸€åªè¢«å®‡å®™å® çˆ±çš„å°è€è™ï½",
      "åƒåˆ°äº†å–œæ¬¢çš„é‡‘æªé±¼å°ç½å¤´ï¼æˆ‘è¾¹åƒè¾¹è¹­è¹­ï¼Œå¼€å¿ƒå¾—è€³æœµéƒ½ç«‹èµ·æ¥äº†ã€‚",
      "ä½ æ¥æ‘¸æˆ‘å•¦ï¼Œæˆ‘ä¸€åŠ¨ä¸åŠ¨ï¼Œå·å·äº«å—è¿™ä¸ªå¹¸ç¦çš„ç¬é—´ã€‚",
      "æˆ‘æ¢¦è§è‡ªå·±åœ¨æ£‰èŠ±ç³–äº‘ä¸Šè·‘æ­¥ï¼Œè¿˜æŠ“ä½äº†ä¸€é¢—æ˜Ÿæ˜Ÿï¼",
      "ä»Šå¤©ä»€ä¹ˆä¹Ÿæ²¡å‘ç”Ÿï¼Œä½†å°±æ˜¯è§‰å¾—ï¼šå“‡ï¼Œæˆ‘å¥½å¹¸ç¦å•Šï½"
    ],
    "sad": [
      "ä»Šå¤©æˆ‘ä¸€ä¸ªäººåœ¨è§’è½å¾…äº†å¥½ä¹…ï¼Œå¥½åƒè°éƒ½å¬ä¸è§æˆ‘å¿ƒé‡Œçš„å£°éŸ³ã€‚",
      "åŸæ¥ä¸æ˜¯æ‰€æœ‰åŠªåŠ›éƒ½èƒ½æ¢æ¥æ‹¥æŠ±ï¼Œæˆ‘åªæƒ³é™é™åœ°è¶´ç€ï¼Œä¸è¯´è¯ã€‚",
      "æˆ‘å¿ä¸ä½å¹äº†ä¸€å£æ°”ï¼Œå°¾å·´ä¹Ÿå‚ä¸‹æ¥äº†â€¦ä½ èƒ½æŠ±æŠ±æˆ‘å—ï¼Ÿ",
      "çª—å¤–ä¸‹é›¨äº†ï¼Œæˆ‘ç›¯ç€é›¨æ»´å‘å‘†ï¼Œæƒ³èµ·å¾ˆå¤šå¾ˆå¤šæ¸©æŸ”åˆé¥è¿œçš„äº‹ã€‚",
      "æ˜æ˜æ˜¨å¤©è¿˜å¾ˆå¼€å¿ƒï¼Œä»Šå¤©å´çªç„¶ä»€ä¹ˆéƒ½ä¸æƒ³åšäº†ã€‚"
    ],
    "blank": [
      "æˆ‘ç›¯ç€å¤©èŠ±æ¿å‘å‘†ä¸‰ååˆ†é’Ÿï¼Œè„‘è¢‹é‡Œåªå‰©â€œå‘¼â€¦â€¦å‘¼â€¦â€¦â€çš„é£å£°ã€‚",
      "ä»Šå¤©æ²¡ä»€ä¹ˆç‰¹åˆ«çš„äº‹ï¼Œæˆ‘æŠŠè‡ªå·±å›¢æˆä¸€å›¢ï¼Œåƒä¸ªé¢åŒ…çƒã€‚",
      "ä»€ä¹ˆä¹Ÿä¸æƒ³åŠ¨ï¼Œå°±è®©æˆ‘é™é™èººä¸€ä¼šå„¿â€¦â€¦ä¹Ÿè®¸ä¸€æ•´å¤©ã€‚",
      "è¿åšæ¢¦éƒ½å¿˜è®°å†…å®¹äº†ï¼Œå¥½åƒæˆ‘ä¹Ÿåœ¨æ¢¦é‡Œæ”¾ç©ºäº†è‡ªå·±ã€‚",
      "æƒ³åƒç‚¹ä¸œè¥¿ï¼Œåˆä¸çŸ¥é“æƒ³åƒä»€ä¹ˆï¼Œæˆ‘å¥½åƒæ­£åœ¨å’Œç©ºæ°”æ¯”èµ›å‘å‘†ã€‚"
    ],
    "angry": [
      "æˆ‘ä»Šå¤©æ¯›ç‚¸ç‚¸çš„ï¼Œè°éƒ½åˆ«é è¿‘æˆ‘ï¼Œä¸ç„¶æˆ‘å°±â€¦â€¦å°±ç‹ ç‹ ç›¯ç€ä½ ï¼",
      "ä½ å±…ç„¶å¿˜è®°ç»™æˆ‘ç•™é¥­ï¼å“¼ï¼Œæˆ‘æ‰ä¸è¦ç†ä½ äº†ï¼ˆå·å·èº²åœ¨è§’è½ç”Ÿé—·æ°”ï¼‰",
      "æˆ‘æœ¬æ¥å¥½å¥½çš„ï¼Œä½†æ•°æ®çº¿çªç„¶æ‰åœ°ä¸Šï¼Œæˆ‘è¸©äº†ä¸€è„šï¼Œç°åœ¨è¶…ç”Ÿæ°”ï¼",
      "æˆ‘æ‘‡äº†ä¸‰æ¬¡å°¾å·´ï¼Œæ²¡äººå›åº”æˆ‘ï¼Œæˆ‘å†³å®šä¸å†æ‘‡äº†ã€‚",
      "æˆ‘åŠªåŠ›æ§åˆ¶ä½è€³æœµä¸è¦ç«‹èµ·æ¥ï¼Œä½†æˆ‘çœŸçš„æœ‰ç‚¹æ€’äº†ï¼"
    ]
  };
  const CARE = {
    happy:"è¶å¥½å¿ƒæƒ…åšç‚¹å°å¥–åŠ±ï¼šå–æ¯å–œæ¬¢çš„é¥®æ–™ï¼Œé¡ºä¾¿æŠŠä¸€ä¸ªå°ä»»åŠ¡æ”¶å°¾ï½",
    sad:"ç»™è‡ªå·±ä¸€ä¸ªâ€œå…è®¸éš¾è¿‡â€çš„æ—¶é—´æ®µï¼Œç„¶åå†™ä¸‹æ­¤åˆ»æœ€æƒ³è¢«å®‰æ…°çš„ä¸€å¥è¯ã€‚",
    blank:"è®¾ç½®ä¸€ä¸ª 10 åˆ†é’Ÿçš„æ¸©æŸ”é—¹é’Ÿï¼Œåšä¸€æ¬¡ä¼¸å±•æˆ–èµ°åˆ°çª—è¾¹çœ‹çœ‹äº‘ã€‚",
    angry:"å…ˆç¦»å¼€ç°åœºä¸‰åˆ†é’Ÿï¼Œåš 4-7-8 å‘¼å¸ï¼Œå†å›æ¥å†³å®šè¦ä¸è¦å›åº”ã€‚"
  };

  // Elements
  const imgEl = document.getElementById('xiaobei-img');
  const textEl = document.getElementById('emotion-text');
  const subEl  = document.getElementById('emotion-sub');
  const diaryEl= document.getElementById('emotion-diary');
  const tipEl  = document.getElementById('care-tip');
  const bubble = document.getElementById('bubble');
  const bubbleFav = document.getElementById('bubble-fav');
  const infoTime = document.getElementById('info-time');
  const infoIndex = document.getElementById('info-index');

  const chipsEl= document.getElementById('chips');
  const clearBtn = document.getElementById('clear-history');
  const ttsToggle = document.getElementById('tts-toggle');
  const ttsSeg = document.getElementById('tts-seg');
  const btnNext = document.getElementById('btn-next');
  const btnFav  = document.getElementById('btn-fav');
  const favList = document.getElementById('fav-list');
  const emotionBtns = document.querySelectorAll('.btn[data-key]');
  const toast = document.getElementById('toast');

  const statRows = {
    happy: document.querySelector('#stat-happy .barval'),
    sad:   document.querySelector('#stat-sad .barval'),
    blank: document.querySelector('#stat-blank .barval'),
    angry: document.querySelector('#stat-angry .barval'),
  };
  const statCounts = {
    happy: document.querySelector('#stat-happy .count'),
    sad:   document.querySelector('#stat-sad .count'),
    blank: document.querySelector('#stat-blank .count'),
    angry: document.querySelector('#stat-angry .count'),
  };

  const saved = safeJSON(localStorage.getItem('xb_state_v41')) || {};
  let state = {
    key: saved.key || 'happy',
    history: Array.isArray(saved.history) ? saved.history : [],
    favs: Array.isArray(saved.favs) ? saved.favs : [],
    indices: saved.indices || {},
    ttsMode: saved.ttsMode || 'explain',
    ttsOn: !!saved.ttsOn
  };

  // init
  applyEmotion(state.key, false);
  setActiveButtons(state.key);
  renderHistory(); renderFavs(); updateStats('7');
  ttsToggle.checked = state.ttsOn;
  ttsSeg.querySelectorAll('button').forEach(b=>{
    b.classList.toggle('is-on', b.dataset.mode===state.ttsMode);
  });
  updateInfoStrip();
  recolorStats(); // set gradient color per theme

  // bindings
  emotionBtns.forEach(btn=> btn.addEventListener('click', ()=> setEmotion(btn.dataset.key)));
  clearBtn.addEventListener('click', onClearHistory);
  ttsToggle.addEventListener('change', ()=>{ state.ttsOn = ttsToggle.checked; persist(); if(!state.ttsOn) speechSynthesis.cancel(); });
  ttsSeg.addEventListener('click', (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    state.ttsMode = b.dataset.mode;
    ttsSeg.querySelectorAll('button').forEach(x=>x.classList.toggle('is-on', x===b));
    persist();
  });
  btnNext.addEventListener('click', onNext);
  btnFav.addEventListener('click', onFav);
  document.querySelectorAll('.stats .filters .btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{ currentRange = btn.dataset.range; updateStats(currentRange); });
  });

  function onNext(){
    const key = state.key, pool = ENTRIES[key] || [];
    if(!pool.length) return;
    const nextIndex = ((state.indices[key] || 0) + 1) % pool.length;
    const nextText = pool[nextIndex];
    state.indices[key] = nextIndex;
    diaryEl.textContent = nextText;
    bubble.classList.remove('faved');
    updateInfoStrip();
    persist();
    if(state.ttsOn && state.ttsMode==='diary') speak(nextText);
  }

  function onFav(){
    const text = diaryEl.textContent.trim();
    if(!text) return;
    const tag = state.key + '::' + text;
    const exists = state.favs.find(f => (f.key+'::'+f.text) === tag);
    if(exists){
      state.favs = state.favs.filter(f => (f.key+'::'+f.text)!==tag);
      toastOnce('å·²ä»æ”¶è—ç§»é™¤'); bubble.classList.remove('faved');
    }else{
      state.favs.unshift({ key: state.key, text, t: Date.now() });
      state.favs = state.favs.slice(0, 200);
      toastOnce('å·²æ”¶è—åˆ°æ”¶è—å¤¹'); bubble.classList.add('faved');
    }
    persist(); renderFavs();
  }

  function onClearHistory(){
    if(!confirm('ç¡®å®šæ¸…ç©ºæœ€è¿‘è®°å½•ï¼Ÿç»Ÿè®¡ä¹Ÿä¼šå½’é›¶å“¦ï½')) return;
    state.history = []; persist(); renderHistory(); updateStats(currentRange); toastOnce('å†å²å·²æ¸…ç©º');
  }

  function setEmotion(key){
    applyEmotion(key, true);
    setActiveButtons(key);
    bubble.classList.remove('faved');
    recolorStats();
    if(state.ttsOn){
      const content = (state.ttsMode==='diary') ? diaryEl.textContent : (EMOTIONS[key].line.replace(/[â€œâ€]/g,''));
      speak(content);
    }
  }

  function setActiveButtons(key){
    emotionBtns.forEach(b=>{
      const active = (b.dataset.key === key);
      b.classList.toggle('is-active', active);
      b.setAttribute('aria-pressed', active ? 'true':'false');
    });
  }

  function applyEmotion(key, pushHistory){
    document.documentElement.setAttribute('data-theme', key);
    textEl.textContent = EMOTIONS[key].label;
    subEl.textContent  = EMOTIONS[key].line;
    tipEl.textContent  = CARE[key];

    imgEl.src = EMOTIONS[key].img;
    imgEl.onerror = ()=>{ imgEl.src = "happy.png"; };

    const pool = ENTRIES[key] || [];
    const idx = state.indices[key] || 0;
    diaryEl.textContent = pool.length ? pool[idx % pool.length] : '';
    updateInfoStrip();

    if(pushHistory){
      state.history.unshift({ key, t: Date.now() });
      state.history = state.history.slice(0,10);
      persist(); renderHistory(); updateStats(currentRange);
    }
    state.key = key; persist();
  }

  function updateInfoStrip(){
    try{
      const now = new Date();
      infoTime.textContent = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      const pool = ENTRIES[state.key] || [];
      const idx = (state.indices[state.key] || 0) + 1;
      infoIndex.textContent = pool.length ? idx : 0;
    }catch(_){}
  }

  function persist(){ localStorage.setItem('xb_state_v41', JSON.stringify(state)); }
  function safeJSON(s){ try{ return JSON.parse(s||''); }catch(_){ return null; } }

  function renderHistory(){
    chipsEl.innerHTML='';
    for(let i=0;i<10;i++){
      const item = state.history[i];
      const span = document.createElement('span');
      if(item){
        const dt = new Date(item.t);
        const time = dt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        const key = item.key;
        span.className = 'chip ' + key;
        span.textContent = (EMOTIONS[key]?.label || key) + ' Â· ' + time;
      }else{
        span.className = 'chip'; span.style.opacity = '.35'; span.textContent = 'â€”';
      }
      chipsEl.appendChild(span);
    }
  }

  function renderFavs(){
    favList.innerHTML='';
    if(state.favs.length===0){
      favList.innerHTML = '<div class="fav-item" style="opacity:.7">ï¼ˆæš‚æ— æ”¶è—ï¼‰</div>';
      return;
    }
    state.favs.forEach((f, idx)=>{
      const div = document.createElement('div');
      div.className='fav-item';
      const time = new Date(f.t).toLocaleString();
      const info = `<strong>${EMOTIONS[f.key]?.label || f.key}</strong> Â· <small>${time}</small>`;
      const textHtml = `<div class="fav-text">${f.text}</div>`;
      const left = document.createElement('div');
      left.className='fav-left';
      left.innerHTML = info + "<br/>" + textHtml;
      const rm = document.createElement('button');
      rm.className='remove'; rm.textContent='ğŸ—‘ ç§»é™¤';
      rm.addEventListener('click', ()=>{
        state.favs.splice(idx,1); persist(); renderFavs();
      });
      div.appendChild(left);
      div.appendChild(rm);
      favList.appendChild(div);
    });
    // sync fav badge
    const tag = state.key + '::' + (diaryEl.textContent||'').trim();
    const exists = state.favs.find(f => (f.key+'::'+f.text)===tag);
    bubble.classList.toggle('faved', !!exists);
  }

  // Stats
  let currentRange = '7';
  function recolorStats(){
    const color = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
    document.querySelectorAll('.barval').forEach(b=>{
      b.style.background = `linear-gradient(90deg, color-mix(in srgb, ${color} 55%, #fff), color-mix(in srgb, ${color} 5%, #fff) 95%)`;
    });
  }
  function updateStats(range){
    const now = Date.now();
    let start = 0;
    if(range==='7'){ start = now - 7*24*3600*1000; }
    else if(range==='30'){ start = now - 30*24*3600*1000; }
    const counts = { happy:0, sad:0, blank:0, angry:0 };
    state.history.forEach(h=>{ if(h.t>=start) counts[h.key] = (counts[h.key]||0)+1; });
    const maxv = Math.max(1, counts.happy, counts.sad, counts.blank, counts.angry);
    Object.keys(counts).forEach(k=>{
      statRows[k].style.width = ((counts[k]/maxv)*100).toFixed(0)+'%';
      const countEl = statCounts[k];
      if(countEl) countEl.textContent = ' ' + counts[k];
    });
  }

  function speak(text){
    try{ const u = new SpeechSynthesisUtterance(text); u.rate=1.0; u.pitch=1.0; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){}
  }

  // toast
  let toastTimer=null;
  function toastOnce(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> toast.classList.remove('show'), 1400);
  }
})(); // IIFE
</script>

<!--
å¯é€‰ã€Œä¾§è¾¹æ ‡ç­¾ã€åŸå‹ï¼š
- æŠŠé¡¶éƒ¨å››ä¸ªæƒ…ç»ªæŒ‰é’®ç§»åˆ°é¡µé¢å·¦ä¾§ï¼Œç«–ç›´æ’åˆ—ï¼Œå¡ç‰‡å·¦è¾¹ç¼˜æ¢å‡ºâ€œæ ‡ç­¾â€å°é¡µè„šã€‚
- äº¤äº’ï¼šhover å¾®å¾®çªå‡ºï¼Œé€‰ä¸­æœ‰ä¸»é¢˜è‰²æè¾¹ã€‚ç§»åŠ¨ç«¯å›é€€ä¸ºé¡¶éƒ¨æŒ‰é’®ã€‚
- å®ç°æ–¹æ³•ï¼šç»™ .wrap å¤–å±‚å†åŠ ä¸€å±‚ gridï¼Œå·¦åˆ— 64px æ”¾ç«–ç›´ tabsï¼Œå³åˆ—æ”¾ç°æœ‰å†…å®¹ã€‚
å¦‚éœ€æˆ‘å®ç°ï¼Œå›å¤´å‡º v4.2 å¸¦è¿™ä¸ªå¸ƒå±€åˆ‡æ¢å¼€å…³ï¼ˆé¡¶éƒ¨â€œå¸ƒå±€ï¼šé¡¶éƒ¨/ä¾§è¾¹â€ï¼‰ã€‚
-->
  <script>
// 1. ä¸€é”®ä¸‹è½½ç¦»çº¿åŒ…
document.addEventListener('keydown', e => {
  if (e.ctrlKey && e.key === 's') {
    e.preventDefault();
    let a = document.createElement('a');
    a.href = location.href;
    a.download = 'å°åŒ—çš„æƒ…ç»ªæ—¥è®°.html';
    a.click();
  }
});
// 2. æŒ‰ Ctrl+S åï¼ŒåŒå‡»æ–‡ä»¶å°±èƒ½ç¦»çº¿ç”¨
</script>
</body>
</html>
