<!DOCTYPE html>
<html lang="zh" data-theme="happy">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>小北的情绪日记 · v4.1</title>
<style>
  :root{
    --text:#111827; --muted:#6b7280;
    --card: rgba(255,255,255,.86);
    --chip: rgba(255,255,255,.96);
    --happy:#ff9cc6; --sad:#9ab6ff; --blank:#69d3b0; --angry:#ffb277;
  }
  html[data-theme="happy"] { --accent:var(--happy); --g1:#fff1f6; --g2:#ffe4e6; --g3:#ffd8e4; }
  html[data-theme="sad"]   { --accent:var(--sad);   --g1:#eef4ff; --g2:#e0eaff; --g3:#d6e6ff; }
  html[data-theme="blank"] { --accent:var(--blank); --g1:#ecfdf5; --g2:#defcf3; --g3:#d0f7e8; }
  html[data-theme="angry"] { --accent:var(--angry); --g1:#fff4e6; --g2:#ffe8cc; --g3:#ffdcb5; }

  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh; color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans SC","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
    background:
      radial-gradient(1200px 800px at 10% 10%, var(--g1), transparent 60%),
      radial-gradient(1000px 700px at 90% 20%, var(--g2), transparent 60%),
      radial-gradient(900px 600px at 30% 90%, var(--g3), transparent 60%),
      linear-gradient(180deg, var(--g1), var(--g2));
  }

  .wrap{ width:clamp(320px, 92vw, 1080px); margin:0 auto; padding:26px 12px 70px; text-align:center; }

  h1{ margin:0 0 6px; font-weight:900; font-size:clamp(30px,4.5vw,44px); letter-spacing:.2px;}
  .sub{ margin:0 0 14px; color:var(--muted); font-size:14px; }

  .bar{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin:12px 0 6px; }
  .btn{
    appearance:none;border:1.5px solid #e5e7eb;cursor:pointer; padding:8px 14px;border-radius:999px;
    font-size:14px;font-weight:700; background:#fff; color:#111827;
    transition: transform .08s ease, filter .2s ease, border-color .2s ease, box-shadow .2s ease, background .2s ease;
  }
  .btn:hover{ transform: translateY(-1px); filter:brightness(1.02); }
  .btn:active{ transform: translateY(1px) scale(.98); }
  .btn.is-active{ border-color: var(--accent); background: #fff6; box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 25%, transparent); }

  .card{
    margin:12px auto; padding:14px; border-radius:16px;
    width:min(1080px, 98%);
    background: var(--card);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    box-shadow: 0 8px 32px rgba(0,0,0,.12);
    text-align:left;
  }

  /* top card */
  .row-top{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; align-items:start; }
  @media (max-width:900px){ .row-top{ grid-template-columns: 1fr; } }
  .imgbox{ display:flex; align-items:center; justify-content:center; }
  #xiaobei-img{ max-width:min(460px,100%); border-radius:14px; }

  .col-right{ display:grid; grid-template-rows: auto auto; gap:10px; }

  .text-block{
    padding:12px 14px; border-radius:14px; background:#fff; box-shadow: 0 1px 0 rgba(0,0,0,.03) inset;
  }
  .emotion-title{ margin:0 0 8px; font-size:clamp(26px,3.2vw,32px); font-weight:900; }
  .emotion-title .label{ color:#111827; }
  .emotion-title .value{ color:var(--accent); font-weight:900; font-size:1.1em; }
  .emotion-sub{ margin:0 0 8px; font-size:clamp(16px,2.1vw,18px); color:#475569; }

  /* diary bubble with accent border and footer tools */
  .bubble{
    position:relative; margin:10px 0 0; border-radius:16px; background:#fff;
    border:2px solid color-mix(in srgb, var(--accent) 35%, #e5e7eb);
    box-shadow: 0 2px 10px rgba(0,0,0,.05);
    overflow:hidden;
  }
  .bubble::before{ content:""; position:absolute; left:0; top:0; bottom:44px; width:3px; background:var(--accent); opacity:.6; }
  .bubble .content{ padding:12px 14px; font-size:clamp(16px,2.1vw,18px); line-height:1.8; color:#111827; }
  .bubble .fav-badge{
    position:absolute; right:10px; top:10px; font-size:14px; display:none;
  }
  .bubble.faved .fav-badge{ display:inline; }
  .bubble .footer{
    display:flex; align-items:center; gap:8px; padding:8px 10px; border-top:1px solid #eef2f7; background: #fafafa;
  }
  .pill{
    padding:6px 10px; border-radius:999px; border:1px solid #e5e7eb; background:#fff;
    font-size:13px; display:inline-flex; align-items:center; gap:6px; cursor:pointer;
  }
  .pill:active{ transform:translateY(1px); }
  .pill .ico{ font-size:16px; }

  /* TTS segmented control redesign */
  .tts-seg{ display:inline-flex; background:#fff; border:1px solid #e5e7eb; border-radius:999px; overflow:hidden; }
  .tts-seg button{
    padding:6px 12px; font-size:12px; border:none; background:#fff; cursor:pointer; display:flex; align-items:center; gap:6px;
  }
  .tts-seg button .dot{ width:8px; height:8px; border-radius:50%; background:#e5e7eb; }
  .tts-seg button.is-on{ background: color-mix(in srgb, var(--accent) 12%, #fff); font-weight:700; }
  .tts-seg button.is-on .dot{ background: var(--accent); }
  .switch{ display:inline-flex; align-items:center; gap:6px; }
  .switch input{ width:36px; height:20px; appearance:none; background:#e5e7eb; border-radius:999px; position:relative; outline:none; cursor:pointer;}
  .switch input:checked{ background:color-mix(in srgb, var(--accent) 45%, #e5e7eb); }
  .switch input::after{ content:""; position:absolute; width:16px; height:16px; top:2px; left:2px; background:#fff; border-radius:50%; transition: left .15s; }
  .switch input:checked::after{ left:18px; }

  .tip{ margin-top:8px; padding:8px 10px; border-radius:10px; background:rgba(0,0,0,.04); color:#374151; font-size:13px; }
  .info-strip{ margin-top:6px; font-size:12px; color:#6b7280; }

  /* mid grid */
  .mid-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
  @media (max-width:900px){ .mid-grid{ grid-template-columns: 1fr; } }

  .section-title{ margin:6px 0 8px; font-size:15px; color:#374151; font-weight:800; display:flex; align-items:center; justify-content:space-between; }
  .section-title .small{ font-size:12px; color:#6b7280; }

  .stats{ display:flex; flex-direction:column; gap:10px; }
  .stats .filters{ display:flex; gap:6px; flex-wrap:wrap; }

  .barrow{ display:flex; align-items:center; gap:10px; }
  .barrow .label{ width:44px; text-align:right; font-size:12px; color:#374151; }
  .barwrap{ flex:1; height:16px; background:#fff; border-radius:999px; overflow:hidden; }
  .barval{ height:100%; width:0%; transition: width .4s ease; background:linear-gradient(90deg, color-mix(in srgb, var(--accent) 55%, #fff), color-mix(in srgb, var(--accent) 5%, #fff) 95%); }

  .fav-list{ display:flex; flex-direction:column; gap:8px; max-height:260px; overflow:auto; padding-right:4px; }
  .fav-item{ display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:12px; background: var(--chip); font-size:14px; }
  .fav-item small{ color:#6b7280; }
  .fav-left{ flex:1 1 auto; min-width:0; }
  .fav-text{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  .fav-item .remove{ flex:0 0 auto; white-space:nowrap; line-height:1; padding:4px 8px; font-size:12px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
  .fav-item .remove:active{ transform:translateY(1px); }

  .chips{ display:grid; gap:8px; grid-template-columns: repeat(5, 1fr); }
  @media (max-width:900px){ .chips{ grid-template-columns: repeat(3, 1fr); } }
  @media (max-width:560px){ .chips{ grid-template-columns: repeat(2, 1fr); } }
  .chip{ padding:8px 10px; border-radius:12px; background:var(--chip); font-size:12px; color:#111827; user-select:none; text-align:center; border:1px solid #e5e7eb; }
  .chip.happy{ background: color-mix(in srgb, var(--happy) 15%, #fff); }
  .chip.sad{ background: color-mix(in srgb, var(--sad) 15%, #fff); }
  .chip.blank{ background: color-mix(in srgb, var(--blank) 15%, #fff); }
  .chip.angry{ background: color-mix(in srgb, var(--angry) 15%, #fff); }

  footer{ margin-top:14px; color:#6b7280; font-size:12px; text-align:center; }

  .toast{
    position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%);
    background: #111827; color:#fff; padding:10px 14px; border-radius:999px; font-size:13px;
    opacity:0; pointer-events:none; transition: opacity .2s, transform .2s;
  }
  .toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px); }
</style>
</head>
<body>
  <div class="wrap">
    <h1>🐯 小北的情绪日记</h1>
    <p class="sub">点击心情切换；随机小日记与收藏；统计面板与历史记录，本地保存。</p>

    <div class="bar" role="group" aria-label="情绪选择">
      <button class="btn" data-key="happy" aria-pressed="true">开心</button>
      <button class="btn" data-key="sad" aria-pressed="false">难过</button>
      <button class="btn" data-key="blank" aria-pressed="false">放空</button>
      <button class="btn" data-key="angry" aria-pressed="false">生气</button>
    </div>

    <div class="card">
      <div class="row-top">
        <div class="imgbox">
          <img id="xiaobei-img" src="happy.png" alt="小北表情"/>
        </div>
        <div class="col-right">
          <div class="text-block">
            <div class="emotion-title"><span class="label">小北现在的情绪是：</span><span id="emotion-text" class="value">开心</span></div>
            <div class="emotion-sub" id="emotion-sub">“今天也要被好好抱抱～”</div>

            <div class="bubble" id="bubble">
              <span class="fav-badge" id="bubble-fav">❤️</span>
              <div class="content" id="emotion-diary"></div>
              <div class="footer">
                <button class="pill" id="btn-next"><span class="ico">🔀</span><span>换一条</span></button>
                <button class="pill" id="btn-fav"><span class="ico">❤️</span><span>收藏</span></button>
                <span class="pill" style="gap:10px; background:#fff;">
                  <span class="ico">🔊</span>
                  <span class="tts-seg" id="tts-seg">
                    <button data-mode="explain" class="is-on"><span class="dot"></span>解释</button>
                    <button data-mode="diary"><span class="dot"></span>日记</button>
                  </span>
                  <label class="switch"><input type="checkbox" id="tts-toggle" aria-label="开启语音播报"></label>
                </span>
              </div>
            </div>

            <div class="tip" id="care-tip"></div>
            <div class="info-strip" id="info-strip">📅 今天 · <span id="info-time">--:--</span> ｜ 本情绪第 <span id="info-index">1</span> 条日记</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="mid-grid">
        <div>
          <div class="section-title">📊 情绪统计 <span class="small">（来自最近记录）</span></div>
          <div class="stats">
            <div class="filters">
              <button class="btn" style="padding:6px 10px;font-size:12px" data-range="7">最近7天</button>
              <button class="btn" style="padding:6px 10px;font-size:12px" data-range="30">最近30天</button>
              <button class="btn" style="padding:6px 10px;font-size:12px" data-range="all">全部</button>
            </div>
            <div id="stat-happy" class="barrow"><div class="label">开心</div><div class="barwrap"><div class="barval"></div></div><span class="count"></span></div>
            <div id="stat-sad" class="barrow"><div class="label">难过</div><div class="barwrap"><div class="barval"></div></div><span class="count"></span></div>
            <div id="stat-blank" class="barrow"><div class="label">放空</div><div class="barwrap"><div class="barval"></div></div><span class="count"></span></div>
            <div id="stat-angry" class="barrow"><div class="label">生气</div><div class="barwrap"><div class="barval"></div></div><span class="count"></span></div>
          </div>
        </div>
        <div>
          <div class="section-title">💖 收藏夹 <span class="small">（点击右侧垃圾桶移除）</span></div>
          <div id="fav-list" class="fav-list"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">🕒 最近 10 次心情
        <button id="clear-history" class="btn" style="padding:6px 10px;font-size:12px">清空</button>
      </div>
      <div id="chips" class="chips" aria-live="polite"></div>
    </div>

    <footer>数据保存在本地：刷新也会记住小北的最新心情、收藏与历史。</footer>
  </div>
  <div id="toast" class="toast">已收藏</div>

<script>
(function(){
  const EMOTIONS = {
    happy : { label:"开心",  img:"happy.png",  line:"“今天也要被好好抱抱～”", color:"var(--happy)" },
    sad   : { label:"难过",  img:"sad.png",    line:"“呜呜，今天有点小难过…”", color:"var(--sad)" },
    blank : { label:"放空",  img:"blank.png",  line:"“先啥也不想，发会儿呆。”", color:"var(--blank)" },
    angry : { label:"生气",  img:"angry.png",  line:"“先呼一口气，再抱抱你。”", color:"var(--angry)" },
  };
  const ENTRIES = {
    "happy": [
      "今天阳光好暖，我在窗边晒了一下午，觉得自己是一只被宇宙宠爱的小老虎～",
      "吃到了喜欢的金枪鱼小罐头！我边吃边蹭蹭，开心得耳朵都立起来了。",
      "你来摸我啦，我一动不动，偷偷享受这个幸福的瞬间。",
      "我梦见自己在棉花糖云上跑步，还抓住了一颗星星！",
      "今天什么也没发生，但就是觉得：哇，我好幸福啊～"
    ],
    "sad": [
      "今天我一个人在角落待了好久，好像谁都听不见我心里的声音。",
      "原来不是所有努力都能换来拥抱，我只想静静地趴着，不说话。",
      "我忍不住叹了一口气，尾巴也垂下来了…你能抱抱我吗？",
      "窗外下雨了，我盯着雨滴发呆，想起很多很多温柔又遥远的事。",
      "明明昨天还很开心，今天却突然什么都不想做了。"
    ],
    "blank": [
      "我盯着天花板发呆三十分钟，脑袋里只剩“呼……呼……”的风声。",
      "今天没什么特别的事，我把自己团成一团，像个面包球。",
      "什么也不想动，就让我静静躺一会儿……也许一整天。",
      "连做梦都忘记内容了，好像我也在梦里放空了自己。",
      "想吃点东西，又不知道想吃什么，我好像正在和空气比赛发呆。"
    ],
    "angry": [
      "我今天毛炸炸的，谁都别靠近我，不然我就……就狠狠盯着你！",
      "你居然忘记给我留饭！哼，我才不要理你了（偷偷躲在角落生闷气）",
      "我本来好好的，但数据线突然掉地上，我踩了一脚，现在超生气！",
      "我摇了三次尾巴，没人回应我，我决定不再摇了。",
      "我努力控制住耳朵不要立起来，但我真的有点怒了！"
    ]
  };
  const CARE = {
    happy:"趁好心情做点小奖励：喝杯喜欢的饮料，顺便把一个小任务收尾～",
    sad:"给自己一个“允许难过”的时间段，然后写下此刻最想被安慰的一句话。",
    blank:"设置一个 10 分钟的温柔闹钟，做一次伸展或走到窗边看看云。",
    angry:"先离开现场三分钟，做 4-7-8 呼吸，再回来决定要不要回应。"
  };

  // Elements
  const imgEl = document.getElementById('xiaobei-img');
  const textEl = document.getElementById('emotion-text');
  const subEl  = document.getElementById('emotion-sub');
  const diaryEl= document.getElementById('emotion-diary');
  const tipEl  = document.getElementById('care-tip');
  const bubble = document.getElementById('bubble');
  const bubbleFav = document.getElementById('bubble-fav');
  const infoTime = document.getElementById('info-time');
  const infoIndex = document.getElementById('info-index');

  const chipsEl= document.getElementById('chips');
  const clearBtn = document.getElementById('clear-history');
  const ttsToggle = document.getElementById('tts-toggle');
  const ttsSeg = document.getElementById('tts-seg');
  const btnNext = document.getElementById('btn-next');
  const btnFav  = document.getElementById('btn-fav');
  const favList = document.getElementById('fav-list');
  const emotionBtns = document.querySelectorAll('.btn[data-key]');
  const toast = document.getElementById('toast');

  const statRows = {
    happy: document.querySelector('#stat-happy .barval'),
    sad:   document.querySelector('#stat-sad .barval'),
    blank: document.querySelector('#stat-blank .barval'),
    angry: document.querySelector('#stat-angry .barval'),
  };
  const statCounts = {
    happy: document.querySelector('#stat-happy .count'),
    sad:   document.querySelector('#stat-sad .count'),
    blank: document.querySelector('#stat-blank .count'),
    angry: document.querySelector('#stat-angry .count'),
  };

  const saved = safeJSON(localStorage.getItem('xb_state_v41')) || {};
  let state = {
    key: saved.key || 'happy',
    history: Array.isArray(saved.history) ? saved.history : [],
    favs: Array.isArray(saved.favs) ? saved.favs : [],
    indices: saved.indices || {},
    ttsMode: saved.ttsMode || 'explain',
    ttsOn: !!saved.ttsOn
  };

  // init
  applyEmotion(state.key, false);
  setActiveButtons(state.key);
  renderHistory(); renderFavs(); updateStats('7');
  ttsToggle.checked = state.ttsOn;
  ttsSeg.querySelectorAll('button').forEach(b=>{
    b.classList.toggle('is-on', b.dataset.mode===state.ttsMode);
  });
  updateInfoStrip();
  recolorStats(); // set gradient color per theme

  // bindings
  emotionBtns.forEach(btn=> btn.addEventListener('click', ()=> setEmotion(btn.dataset.key)));
  clearBtn.addEventListener('click', onClearHistory);
  ttsToggle.addEventListener('change', ()=>{ state.ttsOn = ttsToggle.checked; persist(); if(!state.ttsOn) speechSynthesis.cancel(); });
  ttsSeg.addEventListener('click', (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    state.ttsMode = b.dataset.mode;
    ttsSeg.querySelectorAll('button').forEach(x=>x.classList.toggle('is-on', x===b));
    persist();
  });
  btnNext.addEventListener('click', onNext);
  btnFav.addEventListener('click', onFav);
  document.querySelectorAll('.stats .filters .btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{ currentRange = btn.dataset.range; updateStats(currentRange); });
  });

  function onNext(){
    const key = state.key, pool = ENTRIES[key] || [];
    if(!pool.length) return;
    const nextIndex = ((state.indices[key] || 0) + 1) % pool.length;
    const nextText = pool[nextIndex];
    state.indices[key] = nextIndex;
    diaryEl.textContent = nextText;
    bubble.classList.remove('faved');
    updateInfoStrip();
    persist();
    if(state.ttsOn && state.ttsMode==='diary') speak(nextText);
  }

  function onFav(){
    const text = diaryEl.textContent.trim();
    if(!text) return;
    const tag = state.key + '::' + text;
    const exists = state.favs.find(f => (f.key+'::'+f.text) === tag);
    if(exists){
      state.favs = state.favs.filter(f => (f.key+'::'+f.text)!==tag);
      toastOnce('已从收藏移除'); bubble.classList.remove('faved');
    }else{
      state.favs.unshift({ key: state.key, text, t: Date.now() });
      state.favs = state.favs.slice(0, 200);
      toastOnce('已收藏到收藏夹'); bubble.classList.add('faved');
    }
    persist(); renderFavs();
  }

  function onClearHistory(){
    if(!confirm('确定清空最近记录？统计也会归零哦～')) return;
    state.history = []; persist(); renderHistory(); updateStats(currentRange); toastOnce('历史已清空');
  }

  function setEmotion(key){
    applyEmotion(key, true);
    setActiveButtons(key);
    bubble.classList.remove('faved');
    recolorStats();
    if(state.ttsOn){
      const content = (state.ttsMode==='diary') ? diaryEl.textContent : (EMOTIONS[key].line.replace(/[“”]/g,''));
      speak(content);
    }
  }

  function setActiveButtons(key){
    emotionBtns.forEach(b=>{
      const active = (b.dataset.key === key);
      b.classList.toggle('is-active', active);
      b.setAttribute('aria-pressed', active ? 'true':'false');
    });
  }

  function applyEmotion(key, pushHistory){
    document.documentElement.setAttribute('data-theme', key);
    textEl.textContent = EMOTIONS[key].label;
    subEl.textContent  = EMOTIONS[key].line;
    tipEl.textContent  = CARE[key];

    imgEl.src = EMOTIONS[key].img;
    imgEl.onerror = ()=>{ imgEl.src = "happy.png"; };

    const pool = ENTRIES[key] || [];
    const idx = state.indices[key] || 0;
    diaryEl.textContent = pool.length ? pool[idx % pool.length] : '';
    updateInfoStrip();

    if(pushHistory){
      state.history.unshift({ key, t: Date.now() });
      state.history = state.history.slice(0,10);
      persist(); renderHistory(); updateStats(currentRange);
    }
    state.key = key; persist();
  }

  function updateInfoStrip(){
    try{
      const now = new Date();
      infoTime.textContent = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      const pool = ENTRIES[state.key] || [];
      const idx = (state.indices[state.key] || 0) + 1;
      infoIndex.textContent = pool.length ? idx : 0;
    }catch(_){}
  }

  function persist(){ localStorage.setItem('xb_state_v41', JSON.stringify(state)); }
  function safeJSON(s){ try{ return JSON.parse(s||''); }catch(_){ return null; } }

  function renderHistory(){
    chipsEl.innerHTML='';
    for(let i=0;i<10;i++){
      const item = state.history[i];
      const span = document.createElement('span');
      if(item){
        const dt = new Date(item.t);
        const time = dt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        const key = item.key;
        span.className = 'chip ' + key;
        span.textContent = (EMOTIONS[key]?.label || key) + ' · ' + time;
      }else{
        span.className = 'chip'; span.style.opacity = '.35'; span.textContent = '—';
      }
      chipsEl.appendChild(span);
    }
  }

  function renderFavs(){
    favList.innerHTML='';
    if(state.favs.length===0){
      favList.innerHTML = '<div class="fav-item" style="opacity:.7">（暂无收藏）</div>';
      return;
    }
    state.favs.forEach((f, idx)=>{
      const div = document.createElement('div');
      div.className='fav-item';
      const time = new Date(f.t).toLocaleString();
      const info = `<strong>${EMOTIONS[f.key]?.label || f.key}</strong> · <small>${time}</small>`;
      const textHtml = `<div class="fav-text">${f.text}</div>`;
      const left = document.createElement('div');
      left.className='fav-left';
      left.innerHTML = info + "<br/>" + textHtml;
      const rm = document.createElement('button');
      rm.className='remove'; rm.textContent='🗑 移除';
      rm.addEventListener('click', ()=>{
        state.favs.splice(idx,1); persist(); renderFavs();
      });
      div.appendChild(left);
      div.appendChild(rm);
      favList.appendChild(div);
    });
    // sync fav badge
    const tag = state.key + '::' + (diaryEl.textContent||'').trim();
    const exists = state.favs.find(f => (f.key+'::'+f.text)===tag);
    bubble.classList.toggle('faved', !!exists);
  }

  // Stats
  let currentRange = '7';
  function recolorStats(){
    const color = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
    document.querySelectorAll('.barval').forEach(b=>{
      b.style.background = `linear-gradient(90deg, color-mix(in srgb, ${color} 55%, #fff), color-mix(in srgb, ${color} 5%, #fff) 95%)`;
    });
  }
  function updateStats(range){
    const now = Date.now();
    let start = 0;
    if(range==='7'){ start = now - 7*24*3600*1000; }
    else if(range==='30'){ start = now - 30*24*3600*1000; }
    const counts = { happy:0, sad:0, blank:0, angry:0 };
    state.history.forEach(h=>{ if(h.t>=start) counts[h.key] = (counts[h.key]||0)+1; });
    const maxv = Math.max(1, counts.happy, counts.sad, counts.blank, counts.angry);
    Object.keys(counts).forEach(k=>{
      statRows[k].style.width = ((counts[k]/maxv)*100).toFixed(0)+'%';
      const countEl = statCounts[k];
      if(countEl) countEl.textContent = ' ' + counts[k];
    });
  }

  function speak(text){
    try{ const u = new SpeechSynthesisUtterance(text); u.rate=1.0; u.pitch=1.0; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){}
  }

  // toast
  let toastTimer=null;
  function toastOnce(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> toast.classList.remove('show'), 1400);
  }
})(); // IIFE
</script>

<!--
可选「侧边标签」原型：
- 把顶部四个情绪按钮移到页面左侧，竖直排列，卡片左边缘探出“标签”小页脚。
- 交互：hover 微微突出，选中有主题色描边。移动端回退为顶部按钮。
- 实现方法：给 .wrap 外层再加一层 grid，左列 64px 放竖直 tabs，右列放现有内容。
如需我实现，回头出 v4.2 带这个布局切换开关（顶部“布局：顶部/侧边”）。
-->
</body>
</html>
